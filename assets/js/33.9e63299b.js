(window.webpackJsonp=window.webpackJsonp||[]).push([[33,41],{284:function(e,t){e.exports={nameSpacedSlots:function(e,t){return Object.keys(e).filter(e=>e.startsWith(t)).map(e=>e.replace(t,""))}}},288:function(e,t){e.exports={debounce:function(e,t,s){var a;return function(){var l=this,i=arguments,o=function(){a=null,s||e.apply(l,i)},r=s&&!a;clearTimeout(a),a=setTimeout(o,t),r&&e.apply(l,i)}},memoizedDebounce:function(e,t,s,a=(e=>JSON.stringify(e))){var l={};return function(){var i=this,o=arguments,r=a(arguments),n=function(){l[r]=null,s||e.apply(i,o)},d=s&&!l[r];clearTimeout(l[r]),l[r]=setTimeout(n,t),d&&e.apply(i,o)}}}},337:function(e,t,s){},356:function(e,t,s){"use strict";s(337)},499:function(e,t,s){"use strict";s.r(t);s(20),s(21);var a=s(288),l=s(284),i={name:"MapField",components:{Form:()=>s.e(71).then(s.bind(null,421))},props:{value:{type:Array},label:String,readonly:{type:Boolean,default:!1},multiple:{type:Boolean,default:!1},fields:{type:Array|Object,default:()=>[]},errorMessages:{type:Array,default:()=>[]}},data(){return{model:this.value||[],map:null,searchQuery:"",markers:[]}},watch:{value(e){this.model=e||[]},model(e){this.$emit("input",e)}},mounted(){(async function(){return new Promise((e,t)=>{void 0!==window.L&&e();let s=document.getElementById("leaflet-script")||null,a=document.getElementById("leaflet-style")||null;const l=()=>{s.removeEventListener("load",l),e()};if(s)s.addEventListener("load",l);else try{s=document.createElement("script"),s.src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js",s.crossorigin="anonymous",s.async=!0,s.referrerPolicy="origin",s.type="application/javascript",s.id="leaflet-script",s.addEventListener("load",l),document.head.appendChild(s),a=document.createElement("link"),a.rel="stylesheet",a.href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css",a.crossorigin="anonymous",a.id="leaflet-style",document.head.appendChild(a)}catch(e){t(e)}})})().then(this.initMap)},methods:{initMap(){const e=this.model||[];if(e.length>0){const{lat:t,lon:s}=e[e.length-1];this.map=L.map(this.$refs.map).setView([t,s],12),e.forEach((e,t)=>{const s=L.marker([e.lat,e.lon]).addTo(this.map);this.markers[t]=s}),this.map.fitBounds(e.map(e=>[e.lat,e.lon]))}else this.map=L.map(this.$refs.map).setView([0,0],2);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors"}).addTo(this.map),this.handleClickOnMap()},handleClickOnMap(){this.map.on("click",async e=>{const t=e.latlng;this.multiple||(this.removeAllMarkers(),this.model=[]),this.model.push({lat:t.lat,lon:t.lng,pointName:"",extra_fields:{}});const s=L.marker([t.lat,t.lng]).addTo(this.map);this.markers.push(s),await this.reverseGeoCoding(t.lat,t.lng)})},removeAllMarkers(){this.markers.forEach(e=>this.map.removeLayer(e)),this.markers=[]},async reverseGeoCoding(e,t){const s=await this.$axios.get("https://nominatim.openstreetmap.org/reverse",{params:{lat:e,lon:t,format:"json",addressdetails:1,"accept-language":this.$attrs.currentLang||"en"}});s.data&&s.data.display_name?this.model[this.currentIndex].pointName=s.data.display_name:this.model[this.currentIndex].pointName=this.searchQuery},removePointFromModel(e){this.map.removeLayer(this.markers[e]),this.markers.splice(e,1),this.model.splice(e,1),this.model.length>0?this.map.fitBounds(this.model.map(e=>[e.lat,e.lon])):this.map.setView([0,0],2)},async searchLocation(){try{const e=await this.$axios.get("https://nominatim.openstreetmap.org/search",{params:{q:this.searchQuery,format:"json",limit:1}});if(e.data.length>0){this.multiple||(this.removeAllMarkers(),this.model=[]);const{lat:t,lon:s}=e.data[0];this.map.setView([t,s],12);const a=L.marker([t,s]).addTo(this.map);this.markers.push(a),this.model.push({lat:t,lon:s,pointName:this.searchQuery,extra_fields:{}}),await this.reverseGeoCoding(t,s),this.map.fitBounds(this.model.map(e=>[e.lat,e.lon]))}}catch(e){console.error(this.$t("mapo.error.searchError")+": ",e)}},debouncedSearchLocation:Object(a.debounce)((function(){this.searchLocation()}),500),getErrors(e){return this.errorMessages[e]||{}},getFields(e){if(this.hasTemplates){const t=this.templates.find(t=>e[t.tCodeField]==t.tCode);return t?t.fields:[]}return this.fields},templateSlots(e,t){if(this.hasTemplates){const s=this.templates.find(t=>e[t.tCodeField]==t.tCode);return Object(l.nameSpacedSlots)(t,`template.${s.tCode}.`).reduce((e,t)=>({[`template.${s.tCode}.${t}`]:t,...e}),{})}return Object.keys(t).reduce((e,t)=>({[t]:t,...e}),{})}},computed:{lat(){var e;return(null===(e=this.model)||void 0===e?void 0:e.lat)||""},lon(){var e;return(null===(e=this.model)||void 0===e?void 0:e.lon)||""},pointName(){var e;return(null===(e=this.model)||void 0===e?void 0:e.pointName)||""},currentIndex(){return this.model.length>0?this.model.length-1:0},hasTemplates(){return"object"==typeof this.fields&&!Array.isArray(this.fields)},templates(){const e={};return this.hasTemplates&&Object.keys(this.fields).forEach(t=>{const s=this.fields[t],{preview:a,description:l}=s;e[t]={fields:s.fields||s,name:s.name||titleCase(t.replace(/_/," ")),tCode:s.tCode||t,tCodeField:s.tCodeField||"tCode",preview:a,description:l}}),Object.values(e)}}},o=(s(356),s(1)),r=Object(o.a)(i,(function(){var e=this,t=e._self._c;return t("div",[e.label?t("span",{staticClass:"v-label",class:{"error--text":e.hasErrors,"text--secondary":!e.hasErrors}},[e._v(e._s(e.label)+":")]):e._e(),e._v(" "),t("div",{ref:"map",staticClass:"map"}),e._v(" "),t("div",{staticClass:"map-fields"},[t("div",{staticClass:"row search-row"},[t("div",{staticClass:"col-sm-12",staticStyle:{padding:"0px"}},[t("v-text-field",e._b({staticClass:"col",attrs:{label:e.$t("mapo.searchLocation")},on:{input:function(t){return e.debouncedSearchLocation()}},model:{value:e.searchQuery,callback:function(t){e.searchQuery=t},expression:"searchQuery"}},"v-text-field",{...e.$attrs},!1))],1)]),e._v(" "),e._l(e.model,(function(s,a){return t("div",{key:a,staticClass:"row input-gap",staticStyle:{"margin-top":"1rem"}},[t("div",{staticClass:"col-sm-12"},[t("v-divider")],1),e._v(" "),t("div",{staticClass:"col-sm-6"},[t("div",{staticClass:"row"},[t("v-text-field",e._b({ref:"pointName",refInFor:!0,attrs:{label:e.$t("mapo.pointName")},model:{value:s.pointName,callback:function(t){e.$set(s,"pointName",t)},expression:"point.pointName"}},"v-text-field",{...e.$attrs},!1))],1)]),e._v(" "),t("div",{staticClass:"col"},[t("div",{staticClass:"row"},[t("v-text-field",e._b({staticClass:"col-5",attrs:{label:e.$t("mapo.latitude"),readonly:""},model:{value:s.lat,callback:function(t){e.$set(s,"lat",t)},expression:"point.lat"}},"v-text-field",{...e.$attrs},!1)),e._v(" "),t("v-text-field",e._b({staticClass:"col-5",attrs:{label:e.$t("mapo.longitude"),readonly:""},model:{value:s.lon,callback:function(t){e.$set(s,"lon",t)},expression:"point.lon"}},"v-text-field",{...e.$attrs},!1)),e._v(" "),e.readonly?e._e():t("v-btn",{staticClass:"col",attrs:{icon:""},on:{click:function(t){return e.removePointFromModel(a)}}},[t("v-icon",[e._v("mdi-close")])],1)],1)]),e._v(" "),t("div",{staticClass:"col-sm-12"},[t("div",{staticClass:"row"},[t("Form",{attrs:{fields:e.getFields(e.model.extra_fields),errors:e.getErrors(a),readonly:e.readonly,immediate:""},scopedSlots:e._u([e._l(e.templateSlots(e.model,e.$scopedSlots),(function(t,s){return{key:t,fn:function(t){return[e._t(s,null,null,t)]}}}))],null,!0),model:{value:s.extra_fields,callback:function(t){e.$set(s,"extra_fields",t)},expression:"point.extra_fields"}},[e._l(e.templateSlots(e.model,e.$slots),(function(s,a){return t("template",{slot:s},[e._t(a)],2)}))],2)],1)])])}))],2)])}),[],!1,null,null,null);t.default=r.exports}}]);